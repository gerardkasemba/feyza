"use strict";(()=>{var e={};e.id=3807,e.ids=[3807],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84377:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>b,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>y,staticGenerationAsyncStorage:()=>_});var a={};r.r(a),r.d(a,{GET:()=>m,POST:()=>c});var o=r(49303),n=r(88716),s=r(60670),i=r(87070),l=r(65655);let u={1:150,2:300,3:600,4:1200,5:2e3,6:999999};async function m(e){try{let{searchParams:t}=new URL(e.url),r=t.get("lender_type")||"personal",a=await (0,l.f)(),{data:{user:o}}=await a.auth.getUser();if(!o)return i.NextResponse.json({error:"Unauthorized"},{status:401});let{data:n,error:s}=await a.from("users").select("*").eq("id",o.id).single();if(s||!n)return i.NextResponse.json({error:"Profile not found"},{status:404});let{count:m}=await a.from("loans").select("*",{count:"exact",head:!0}).eq("borrower_id",o.id).eq("status","completed"),c=0===(m||0),{data:d}=await a.from("loans").select("amount, amount_remaining, amount_paid").eq("borrower_id",o.id).eq("status","active"),p=d?.reduce((e,t)=>e+(t.amount_remaining||0),0)||0,_=d?.reduce((e,t)=>e+(t.amount||0),0)||0,y=d?.reduce((e,t)=>e+(t.amount_paid||0),0)||0,f=n.borrowing_tier||1,b=n.loans_at_current_tier||0;if("business"===r){let{data:e}=await a.from("lender_preferences").select("max_amount, first_time_borrower_limit, allow_first_time_borrowers").eq("is_active",!0).not("business_id","is",null),t=0;if(e&&e.length>0){if(c){let r=e.filter(e=>!1!==e.allow_first_time_borrowers);t=Math.max(0,...r.map(e=>e.first_time_borrower_limit||e.max_amount||500))}else t=Math.max(0,...e.map(e=>e.max_amount||5e3))}return i.NextResponse.json({canBorrow:!0,reason:"",lenderType:"business",isFirstTimeBorrower:c,maxAvailableFromBusinesses:t,borrowingTier:null,tierName:null,maxAmount:null,availableAmount:null,totalOutstanding:p,borrowerRating:n.borrower_rating||"neutral",message:c?`As a first-time borrower, you'll be matched with lenders who accept new borrowers. Maximum available: $${t.toLocaleString()}`:`You'll be matched with lenders based on their preferences. Maximum available: $${t.toLocaleString()}`,stats:{totalLoansCompleted:n.total_loans_completed||0,totalPaymentsMade:n.total_payments_made||0,paymentsOnTime:n.payments_on_time||0,paymentsEarly:n.payments_early||0,paymentsLate:n.payments_late||0,paymentsMissed:n.payments_missed||0}})}let w=u[f]||150,x=w,g=!0,h="";if(f>=5&&p>=2e3){let e=_>0?y/_:0;e<.75&&(g=!1,h=`You must pay at least 75% of your current loans ($${_.toFixed(2)}) before applying for a new one. Currently paid: ${(100*e).toFixed(0)}%`,x=0)}return f<6&&g&&(x=Math.max(0,w-p))<=0&&(g=!1,h=`You've reached your borrowing limit of $${w}. Pay off existing loans to borrow more.`),i.NextResponse.json({canBorrow:g,reason:h,lenderType:"personal",isFirstTimeBorrower:c,borrowingTier:f,tierName:function(e){switch(e){case 1:default:return"Starter";case 2:return"Bronze";case 3:return"Silver";case 4:return"Gold";case 5:return"Platinum";case 6:return"Diamond (Unlimited)"}}(f),maxAmount:6===f?null:w,availableAmount:6===f?null:x,totalOutstanding:p,loansAtCurrentTier:b,loansNeededToUpgrade:f<6?3-b:0,nextTierAmount:f<6?u[f+1]:null,borrowerRating:n.borrower_rating||"neutral",stats:{totalLoansCompleted:n.total_loans_completed||0,totalPaymentsMade:n.total_payments_made||0,paymentsOnTime:n.payments_on_time||0,paymentsEarly:n.payments_early||0,paymentsLate:n.payments_late||0,paymentsMissed:n.payments_missed||0}})}catch(e){return console.error("Error checking borrower eligibility:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}async function c(e){try{let{amount:t,lenderType:r="personal"}=await e.json();if(!t||t<=0)return i.NextResponse.json({error:"Valid amount is required"},{status:400});let a=await (0,l.f)(),{data:{user:o}}=await a.auth.getUser();if(!o)return i.NextResponse.json({error:"Unauthorized"},{status:401});let{data:n}=await a.from("users").select("*").eq("id",o.id).single();if(!n)return i.NextResponse.json({error:"Profile not found"},{status:404});let{count:s}=await a.from("loans").select("*",{count:"exact",head:!0}).eq("borrower_id",o.id).eq("status","completed"),m=0===(s||0);if("business"===r){let{data:e}=await a.from("lender_preferences").select("max_amount, first_time_borrower_limit, allow_first_time_borrowers, capital_pool").eq("is_active",!0).not("business_id","is",null).gte("capital_pool",t),r=0;e&&e.length>0&&(r=m?e.filter(e=>!1!==e.allow_first_time_borrowers&&(e.first_time_borrower_limit||e.max_amount||500)>=t).length:e.filter(e=>(e.max_amount||5e3)>=t).length);let o=r>0,n="";return o||(n=m?`No business lenders currently accept first-time borrowers at $${t}. Try a lower amount or build history with a personal lender first.`:`No business lenders currently available for $${t}. Try a lower amount.`),i.NextResponse.json({canBorrow:o,reason:n,requestedAmount:t,lenderType:"business",isFirstTimeBorrower:m,matchingLendersCount:r,maxAmount:null})}let c=n.borrowing_tier||1,d=u[c]||150,{data:p}=await a.from("loans").select("amount, amount_remaining, amount_paid").eq("borrower_id",o.id).eq("status","active"),_=p?.reduce((e,t)=>e+(t.amount_remaining||0),0)||0,y=p?.reduce((e,t)=>e+(t.amount||0),0)||0,f=p?.reduce((e,t)=>e+(t.amount_paid||0),0)||0,b=!0,w="";if(c<6&&(t>d?(b=!1,w=`Amount exceeds your tier limit of $${d}`):_+t>d&&(b=!1,w=`Total loans would exceed your limit of $${d}. Available: $${Math.max(0,d-_).toFixed(2)}`)),c>=5&&_>=2e3&&b){let e=y>0?f/y:0;e<.75&&(b=!1,w=`You must pay at least 75% of current loans before borrowing more. Currently paid: ${(100*e).toFixed(0)}%`)}return i.NextResponse.json({canBorrow:b,reason:w,requestedAmount:t,lenderType:"personal",isFirstTimeBorrower:m,maxAmount:6===c?null:d,totalOutstanding:_})}catch(e){return console.error("Error checking amount:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}let d=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/borrower/eligibility/route",pathname:"/api/borrower/eligibility",filename:"route",bundlePath:"app/api/borrower/eligibility/route"},resolvedPagePath:"C:\\Users\\GerardKasemba\\feyza\\src\\app\\api\\borrower\\eligibility\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:p,staticGenerationAsyncStorage:_,serverHooks:y}=d,f="/api/borrower/eligibility/route";function b(){return(0,s.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:_})}},65655:(e,t,r)=>{r.d(t,{f:()=>n,k:()=>s});var a=r(67721),o=r(71615);async function n(){let e=await (0,o.cookies)();return(0,a.createServerClient)("https://mregojhoivbxdvgjrixz.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1yZWdvamhvaXZieGR2Z2pyaXh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1ODE1NDQsImV4cCI6MjA4MzE1NzU0NH0.I_jEMf00cFYAdF0akvD-HOqXWExxO3E0BV69EHEa5jI",{cookies:{getAll:()=>e.getAll(),setAll(t){try{t.forEach(({name:t,value:r,options:a})=>e.set(t,r,a))}catch{}}}})}async function s(){let e=await (0,o.cookies)();return(0,a.createServerClient)("https://mregojhoivbxdvgjrixz.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{cookies:{getAll:()=>e.getAll(),setAll(t){try{t.forEach(({name:t,value:r,options:a})=>e.set(t,r,a))}catch{}}}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[9276,3786,9702,5972],()=>r(84377));module.exports=a})();