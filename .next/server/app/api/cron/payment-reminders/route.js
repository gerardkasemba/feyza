"use strict";(()=>{var e={};e.id=7612,e.ids=[7612],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},79510:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>w,patchFetch:()=>g,requestAsyncStorage:()=>_,routeModule:()=>m,serverHooks:()=>f,staticGenerationAsyncStorage:()=>p});var o={};t.r(o),t.d(o,{GET:()=>c,POST:()=>u});var a=t(49303),i=t(88716),n=t(60670),s=t(87070),l=t(65655),d=t(20471);async function u(e){try{let r=e.headers.get("authorization"),t=process.env.CRON_SECRET;if(t&&r&&r!==`Bearer ${t}`)return s.NextResponse.json({error:"Unauthorized"},{status:401});let o=await (0,l.k)(),a=new Date,i=a.toISOString().split("T")[0],n=0,u=0,c=0,m=0,{data:_,error:p}=await o.from("payment_schedule").select(`
        *,
        loan:loans(
          id,
          amount,
          currency,
          borrower_id,
          borrower_invite_email,
          borrower_access_token,
          lender_id,
          business_lender_id,
          invite_email
        )
      `).eq("status","pending").lt("due_date",i);if(p&&console.error("Error fetching overdue payments:",p),_&&_.length>0)for(let e of _){if(e.overdue_reminder_sent_at){let r=new Date(e.overdue_reminder_sent_at);if((a.getTime()-r.getTime())/36e5<24)continue}let r=e.loan;if(!r)continue;let t=Math.floor((a.getTime()-new Date(e.due_date).getTime())/864e5),i=null,n="there";if(r.borrower_id){let{data:e}=await o.from("users").select("email, full_name").eq("id",r.borrower_id).single();e&&(i=e.email,n=e.full_name||"there")}if(!i&&r.borrower_invite_email&&(i=r.borrower_invite_email),!i)continue;let s="your lender",l=null;if(r.lender_id){let{data:e}=await o.from("users").select("email, full_name").eq("id",r.lender_id).single();e&&(s=e.full_name||"Your lender",l=e.email)}else if(r.business_lender_id){let{data:e}=await o.from("business_profiles").select("business_name, contact_email").eq("id",r.business_lender_id).single();e&&(s=e.business_name,l=e.contact_email)}else r.invite_email&&(l=r.invite_email);try{let m=r.borrower_access_token?`/borrower/${r.borrower_access_token}`:`/loans/${r.id}`,{subject:_,html:p}=(0,d.FJ)({borrowerName:n,lenderName:s,amount:e.amount,currency:r.currency||"USD",dueDate:new Date(e.due_date).toLocaleDateString(),daysOverdue:t,loanId:r.id,loanLink:m});if(await (0,d.Cz)({to:i,subject:_,html:p}),await o.from("payment_schedule").update({overdue_reminder_sent_at:a.toISOString(),status:"overdue"}).eq("id",e.id),!e.overdue_reminder_sent_at&&r.borrower_id&&await o.from("users").update({payments_missed:o.rpc("increment_missed_payments",{user_id:r.borrower_id})}).eq("id",r.borrower_id),u++,l&&!e.overdue_reminder_sent_at){let o=(0,d.AN)({lenderName:s,borrowerName:n||"A borrower",amount:e.amount,currency:r.currency||"USD",dueDate:new Date(e.due_date).toLocaleDateString(),daysOverdue:t,loanId:r.id});await (0,d.Cz)({to:l,subject:o.subject,html:o.html}),c++}}catch(e){console.error(`Failed to send overdue reminder to ${i}:`,e)}}let f=new Date(a.getTime()+6048e5).toISOString().split("T")[0],{data:w,error:g}=await o.from("payment_schedule").select(`
        *,
        loan:loans(
          id,
          currency,
          borrower_id,
          borrower_invite_email,
          borrower_access_token,
          lender_id,
          business_lender_id
        )
      `).eq("status","pending").eq("is_paid",!1).gte("due_date",i).lte("due_date",f).is("reminder_sent_at",null);if(g&&console.error("Error fetching upcoming payments:",g),w&&w.length>0)for(let e of w){let r=e.loan;if(!r)continue;let t=null,i="there",s=!0,l=3;if(r.borrower_id){let{data:e}=await o.from("users").select("email, full_name, email_reminders, reminder_days_before").eq("id",r.borrower_id).single();e&&(t=e.email,i=e.full_name||"there",s=!1!==e.email_reminders,l=e.reminder_days_before||3)}if(!t&&r.borrower_invite_email&&(t=r.borrower_invite_email),t&&s&&!(Math.ceil((new Date(e.due_date).getTime()-a.getTime())/864e5)>l))try{let s=r.borrower_access_token?`/borrower/${r.borrower_access_token}`:`/loans/${r.id}`,{subject:l,html:u}=(0,d.uw)({borrowerName:i,amount:e.amount,currency:r.currency||"USD",dueDate:new Date(e.due_date).toLocaleDateString(),loanId:r.id,loanLink:s});await (0,d.Cz)({to:t,subject:l,html:u}),await o.from("payment_schedule").update({reminder_sent_at:a.toISOString()}).eq("id",e.id),n++}catch(e){console.error(`Failed to send reminder to ${t}:`,e)}}let{data:y,error:b}=await o.from("disbursements").select(`
        *,
        loan:loans(
          id,
          borrower_id,
          borrower:users!borrower_id(email, full_name)
        )
      `).eq("status","ready_for_pickup").eq("disbursement_method","cash_pickup");if(b&&console.error("Error fetching pending pickups:",b),y&&y.length>0)for(let e of y){if(e.last_reminder_sent_at){let r=new Date(e.last_reminder_sent_at);if((a.getTime()-r.getTime())/864e5<7)continue}let r=e.loan?.borrower?.email;if(!r)continue;let t=Math.floor((a.getTime()-new Date(e.created_at).getTime())/864e5);try{let{subject:i,html:n}=(0,d.$H)({borrowerName:e.loan?.borrower?.full_name||"there",recipientName:e.recipient_name,amount:e.amount,currency:e.currency||"USD",pickupLocation:e.pickup_location||"the designated location",pickupCode:e.pickup_code||"N/A",daysWaiting:t});await (0,d.Cz)({to:r,subject:i,html:n}),await o.from("disbursements").update({last_reminder_sent_at:a.toISOString(),reminder_count:(e.reminder_count||0)+1}).eq("id",e.id),m++}catch(e){console.error(`Failed to send cash pickup reminder to ${r}:`,e)}}let{data:h}=await o.from("payment_schedule").select("loan:loans(borrower_id)").eq("status","overdue"),x=[];if(h)for(let e of h){let r=e.loan;r?.borrower_id&&!x.includes(r.borrower_id)&&x.push(r.borrower_id)}for(let e of x)try{let{data:r}=await o.from("users").select("total_payments_made, payments_on_time, payments_early, payments_late, payments_missed").eq("id",e).single();if(r&&r.total_payments_made>0){let t=r.total_payments_made,i=(r.payments_early||0)/t,n=(r.payments_on_time||0)/t,s=(r.payments_late||0)/t,l=(r.payments_missed||0)/t,d="neutral";i>.5?d="great":n+i>.8?d="good":s+l>=.3&&s+l<.5?d="poor":s>.5?d="bad":l>.7&&(d="worst"),await o.from("users").update({borrower_rating:d,borrower_rating_updated_at:a.toISOString()}).eq("id",e)}}catch(r){console.error(`Failed to update rating for user ${e}:`,r)}return s.NextResponse.json({success:!0,timestamp:a.toISOString(),remindersSent:n,overdueRemindersSent:u,lenderNotificationsSent:c,cashPickupRemindersSent:m,ratingsUpdated:x.length})}catch(e){return console.error("Error processing reminders:",e),s.NextResponse.json({error:"Internal server error"},{status:500})}}async function c(e){return s.NextResponse.json({status:"ok",message:"Payment reminder cron endpoint. Send POST request to trigger.",nextRun:"Configure your cron job to call this endpoint daily."})}let m=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/cron/payment-reminders/route",pathname:"/api/cron/payment-reminders",filename:"route",bundlePath:"app/api/cron/payment-reminders/route"},resolvedPagePath:"C:\\Users\\GerardKasemba\\feyza\\src\\app\\api\\cron\\payment-reminders\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:_,staticGenerationAsyncStorage:p,serverHooks:f}=m,w="/api/cron/payment-reminders/route";function g(){return(0,n.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:p})}},65655:(e,r,t)=>{t.d(r,{f:()=>i,k:()=>n});var o=t(67721),a=t(71615);async function i(){let e=await (0,a.cookies)();return(0,o.createServerClient)("https://mregojhoivbxdvgjrixz.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1yZWdvamhvaXZieGR2Z2pyaXh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1ODE1NDQsImV4cCI6MjA4MzE1NzU0NH0.I_jEMf00cFYAdF0akvD-HOqXWExxO3E0BV69EHEa5jI",{cookies:{getAll:()=>e.getAll(),setAll(r){try{r.forEach(({name:r,value:t,options:o})=>e.set(r,t,o))}catch{}}}})}async function n(){let e=await (0,a.cookies)();return(0,o.createServerClient)("https://mregojhoivbxdvgjrixz.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{cookies:{getAll:()=>e.getAll(),setAll(r){try{r.forEach(({name:r,value:t,options:o})=>e.set(r,t,o))}catch{}}}})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[9276,3786,9702,5972,5245,471],()=>t(79510));module.exports=o})();