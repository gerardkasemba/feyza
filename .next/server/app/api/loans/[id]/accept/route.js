"use strict";(()=>{var e={};e.id=4870,e.ids=[4870],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},78250:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>b,patchFetch:()=>x,requestAsyncStorage:()=>d,routeModule:()=>l,serverHooks:()=>_,staticGenerationAsyncStorage:()=>m});var n={};t.r(n),t.d(n,{POST:()=>p});var o=t(49303),i=t(88716),s=t(60670),a=t(87070),c=t(65655),u=t(20471);async function p(e,{params:r}){try{let{id:e}=await r,t=await (0,c.f)(),n=await (0,c.k)(),{data:{user:o}}=await t.auth.getUser();if(!o)return a.NextResponse.json({error:"Unauthorized"},{status:401});let{data:i,error:s}=await t.from("loans").select("*, borrower:users!borrower_id(*)").eq("id",e).single();if(s||!i)return a.NextResponse.json({error:"Loan not found"},{status:404});let p=i.lender_id===o.id,l=o.user_metadata?.full_name||"Your lender";if(!p&&i.business_lender_id){let{data:e}=await t.from("business_profiles").select("user_id, business_name").eq("id",i.business_lender_id).single();p=e?.user_id===o.id,e?.business_name&&(l=e.business_name)}if(!p)return a.NextResponse.json({error:"Not authorized"},{status:403});let{error:d}=await t.from("loans").update({status:"active",lender_id:o.id,updated_at:new Date().toISOString()}).eq("id",e);if(d)return console.error("Error updating loan:",d),a.NextResponse.json({error:"Failed to accept loan"},{status:500});if(i.recipient_name&&i.disbursement_method)try{await n.from("disbursements").insert({loan_id:e,amount:i.amount,currency:i.currency||"USD",disbursement_method:i.disbursement_method,mobile_provider:i.mobile_money_provider,mobile_number:i.mobile_money_phone,mobile_name:i.mobile_money_name,bank_name:i.bank_name,bank_account_name:i.bank_account_name,bank_account_number:i.bank_account_number,bank_branch:i.bank_branch,bank_swift_code:i.bank_swift_code,pickup_location:i.cash_pickup_location,recipient_name:i.recipient_name,recipient_phone:i.recipient_phone,recipient_id_type:i.picker_id_type,recipient_id_number:i.picker_id_number,recipient_country:i.recipient_country,status:"pending"}),console.log("Disbursement created for loan:",e)}catch(e){console.error("Error creating disbursement:",e)}try{await t.from("notifications").insert({user_id:i.borrower_id,loan_id:e,type:"loan_accepted",title:"Loan Accepted! \uD83C\uDF89",message:`Your loan request for ${i.currency} ${i.amount} has been accepted.`})}catch(e){console.error("Error creating notification:",e)}if(i.borrower?.email)try{let{subject:e,html:r}=(0,u.SN)({borrowerName:i.borrower.full_name||"there",lenderName:l,amount:i.amount,currency:i.currency,loanId:i.id});await (0,u.Cz)({to:i.borrower.email,subject:e,html:r})}catch(e){console.error("Error sending email:",e)}return a.NextResponse.json({success:!0,redirectUrl:i.business_lender_id?"/business":`/loans/${e}`})}catch(e){return console.error("Error accepting loan:",e),a.NextResponse.json({error:"Internal server error"},{status:500})}}let l=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/loans/[id]/accept/route",pathname:"/api/loans/[id]/accept",filename:"route",bundlePath:"app/api/loans/[id]/accept/route"},resolvedPagePath:"C:\\Users\\GerardKasemba\\feyza\\src\\app\\api\\loans\\[id]\\accept\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:d,staticGenerationAsyncStorage:m,serverHooks:_}=l,b="/api/loans/[id]/accept/route";function x(){return(0,s.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:m})}},65655:(e,r,t)=>{t.d(r,{f:()=>i,k:()=>s});var n=t(67721),o=t(71615);async function i(){let e=await (0,o.cookies)();return(0,n.createServerClient)("https://mregojhoivbxdvgjrixz.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1yZWdvamhvaXZieGR2Z2pyaXh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1ODE1NDQsImV4cCI6MjA4MzE1NzU0NH0.I_jEMf00cFYAdF0akvD-HOqXWExxO3E0BV69EHEa5jI",{cookies:{getAll:()=>e.getAll(),setAll(r){try{r.forEach(({name:r,value:t,options:n})=>e.set(r,t,n))}catch{}}}})}async function s(){let e=await (0,o.cookies)();return(0,n.createServerClient)("https://mregojhoivbxdvgjrixz.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{cookies:{getAll:()=>e.getAll(),setAll(r){try{r.forEach(({name:r,value:t,options:n})=>e.set(r,t,n))}catch{}}}})}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),n=r.X(0,[9276,3786,9702,5972,5245,471],()=>t(78250));module.exports=n})();