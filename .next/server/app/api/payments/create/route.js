"use strict";(()=>{var e={};e.id=9792,e.ids=[9792],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},79687:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>w,requestAsyncStorage:()=>y,routeModule:()=>c,serverHooks:()=>f,staticGenerationAsyncStorage:()=>g});var a={};r.r(a),r.d(a,{POST:()=>d});var n=r(49303),s=r(88716),i=r(60670),o=r(87070),l=r(65655),u=r(20471);async function d(e){try{let t=await (0,l.f)(),{loanId:r,scheduleId:a,amount:n,note:s,proofUrl:i}=await e.json(),{data:{user:d}}=await t.auth.getUser();if(!d)return o.NextResponse.json({error:"Unauthorized"},{status:401});let{data:c,error:y}=await t.from("loans").select("*, lender:users!lender_id(*), guest_lender:guest_lenders!guest_lender_id(*)").eq("id",r).single();if(y||!c)return o.NextResponse.json({error:"Loan not found"},{status:404});if(c.borrower_id!==d.id)return o.NextResponse.json({error:"Not authorized"},{status:403});let g="on_time",f=0;if(a){let{data:e}=await t.from("payment_schedule").select("due_date").eq("id",a).single();if(e){let t=new Date(e.due_date),r=new Date;r.setHours(0,0,0,0),t.setHours(0,0,0,0),g=(f=Math.floor((r.getTime()-t.getTime())/864e5))<0?"early":0===f?"on_time":"late"}}let{data:x,error:w}=await t.from("payments").insert({loan_id:r,schedule_id:a||null,amount:n,payment_date:new Date().toISOString(),status:"pending",note:s||null,proof_url:i||null}).select().single();if(w)throw w;a&&await t.from("payment_schedule").update({is_paid:!0,status:"paid",payment_id:x.id,paid_at:new Date().toISOString(),paid_days_diff:f}).eq("id",a);let h={total_payments_made:await p(t,d.id,"total_payments_made")+1};"early"===g?h.payments_early=await p(t,d.id,"payments_early")+1:"on_time"===g?h.payments_on_time=await p(t,d.id,"payments_on_time")+1:h.payments_late=await p(t,d.id,"payments_late")+1,await t.from("users").update(h).eq("id",d.id);let q=(c.amount_paid||0)+n,v=Math.max(0,(c.total_amount||c.amount)-q),I=v<=0?"completed":"active";await t.from("loans").update({amount_paid:q,amount_remaining:v,status:I,updated_at:new Date().toISOString()}).eq("id",r),"completed"===I&&await _(t,d.id,c.amount),await m(t,d.id);let b=c.lender?.email||c.guest_lender?.paypal_email||c.invite_email,j=c.lender?.full_name||c.guest_lender?.full_name||"Lender";if(c.lender_id&&await t.from("notifications").insert({user_id:c.lender_id,loan_id:r,type:"payment_received",title:"Payment Received",message:`A payment of ${c.currency} ${n} has been marked as paid and needs your confirmation.`}),b){let{subject:e,html:t}=(0,u.O7)({recipientName:j,amount:n,currency:c.currency,loanId:c.id,role:"lender"});await (0,u.Cz)({to:b,subject:e,html:t})}return o.NextResponse.json({success:!0,payment:x,paymentTiming:g,loan:{amount_paid:q,amount_remaining:v,status:I}})}catch(e){return console.error("Error creating payment:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}async function p(e,t,r){let{data:a}=await e.from("users").select(r).eq("id",t).single();return a?.[r]||0}async function m(e,t){let{data:r}=await e.from("users").select("total_payments_made, payments_on_time, payments_early, payments_late, payments_missed").eq("id",t).single();if(!r||!r.total_payments_made)return;let a=r.total_payments_made,n=r.payments_early/a,s=r.payments_on_time/a,i=r.payments_late/a,o=(r.payments_missed||0)/a,l="neutral";n>.5?l="great":s+n>.8?l="good":i+o>=.3&&i+o<.5?l="poor":i>.5?l="bad":o>.7&&(l="worst"),await e.from("users").update({borrower_rating:l,borrower_rating_updated_at:new Date().toISOString()}).eq("id",t)}async function _(e,t,r){let{data:a}=await e.from("users").select("borrowing_tier, loans_at_current_tier, total_loans_completed").eq("id",t).single();if(!a)return;let n=a.borrowing_tier||1,s=(a.loans_at_current_tier||0)+1,i={loans_at_current_tier:s,total_loans_completed:(a.total_loans_completed||0)+1};n<5&&s>=3?(i.borrowing_tier=n+1,i.loans_at_current_tier=0,i.max_borrowing_amount=({1:150,2:300,3:600,4:1200,5:2e3,6:999999})[n+1]||150):5===n&&r>=2e3&&(i.borrowing_tier=6,i.loans_at_current_tier=0,i.max_borrowing_amount=999999),await e.from("users").update(i).eq("id",t)}let c=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/payments/create/route",pathname:"/api/payments/create",filename:"route",bundlePath:"app/api/payments/create/route"},resolvedPagePath:"C:\\Users\\GerardKasemba\\feyza\\src\\app\\api\\payments\\create\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:y,staticGenerationAsyncStorage:g,serverHooks:f}=c,x="/api/payments/create/route";function w(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:g})}},65655:(e,t,r)=>{r.d(t,{f:()=>s,k:()=>i});var a=r(67721),n=r(71615);async function s(){let e=await (0,n.cookies)();return(0,a.createServerClient)("https://mregojhoivbxdvgjrixz.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1yZWdvamhvaXZieGR2Z2pyaXh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1ODE1NDQsImV4cCI6MjA4MzE1NzU0NH0.I_jEMf00cFYAdF0akvD-HOqXWExxO3E0BV69EHEa5jI",{cookies:{getAll:()=>e.getAll(),setAll(t){try{t.forEach(({name:t,value:r,options:a})=>e.set(t,r,a))}catch{}}}})}async function i(){let e=await (0,n.cookies)();return(0,a.createServerClient)("https://mregojhoivbxdvgjrixz.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{cookies:{getAll:()=>e.getAll(),setAll(t){try{t.forEach(({name:t,value:r,options:a})=>e.set(t,r,a))}catch{}}}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[9276,3786,9702,5972,5245,471],()=>r(79687));module.exports=a})();